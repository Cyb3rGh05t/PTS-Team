---
- name: "Establish Facts"
  set_fact:
    switch: "on"
    updatecheck: "default"

- name: "Docker Check"
  stat:
    path: "/usr/bin/docker"
  register: check

- name: "Docker Version Check - True"
  shell: "docker --version | awk '{print $3}'"
  register: updatecheck

- name: "Switch - On"
  set_fact:
    switch: "off"
  when: updatecheck.stdout == "18.09.2,"

- name: Install required packages
  apt: "name={{item}} state=present"
  with_items:
    - apt-transport-https
    - ca-certificates
    - software-properties-common
  when: switch == "on"

# - name: Docker install Debian
  # shell: bash /opt/plexguide/menu/roles/dockerdeb/files/dockerdeb.sh
  # args:
      # executable: /bin/bash
  # when: switch == "on"

- name: Docker getcommands
  command: curl -fsSL https://get.docker.com -o /home/get-docker.sh
  when: switch == "on"

- name: Old way Docker install
  shel: sudo bash /home/get-docker.sh
  args:
    executable: /bin/bash
  when: switch == "on"

- name: Check docker daemon.json exists
  stat:
    path: /etc/docker/daemon.json
  register: docker_daemon

- name: Stop docker to enable overlay2
  systemd: 
    state: stopped
    name: docker
    enabled: yes
  when:
    - docker_daemon.stat.exists == False
    - switch == "on"

- name: Import daemon.json
  copy: 
    src: daemon.json
    dest: /etc/docker/daemon.json 
    force: yes
    mode: 0775
  when:
    - docker_daemon.stat.exists == False
    - switch == "on"

- name: Start docker (Please Wait)
  systemd: 
    state: started
    name: docker
    enabled: yes
  when:
    - docker_daemon.stat.exists == False
    - switch == "on"

- name: "Wait for 20 seconds before commencing"
  wait_for:
    timeout: 20
  when: switch == "on"

- name: Check override folder exists
  stat:
    path: /etc/systemd/system/docker.service.d
  register: docker_override

- name: Create override folder
  file: 
    path: /etc/systemd/system/docker.service.d
    state: directory
    mode: 0775
  when:
    - docker_override.stat.exists == False
    - switch == "on"
  tags: docker_standard

- name: Import override file
  copy: 
    src: override.conf
    dest: /etc/systemd/system/docker.service.d/override.conf 
    force: yes
    mode: 0775
  tags: docker_standard
  when: switch == "on"

- name: create plexguide network
  docker_network:
    name: "plexguide"
    state: present
  tags: docker_standard
  when: switch == "on"

- name: "Start All Containers"
  shell: "docker start $(docker ps -a -q)"
  ignore_errors: yes
  when:
    - switch == "on"
    - check.stat.exists == True