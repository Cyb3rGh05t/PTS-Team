---
- name: Upgrade APT to the latest packages
  apt: 
    name: "*"
    update_cache: yes
    state: latest
  register: apt_result

- name: Upgrade Distrubution to the latest stable version
  #apt: upgrade=dist state=present only_upgrade=yes
  apt:
    upgrade: dist
    state: present
  register: apt_result
 
- name: Install a list of packages
  apt:
    name:  "{{ packages }}"
    state: latest
    update_cache: yes
    allow_unauthenticated: yes
  vars:
    packages:
    - ctop
    - dnsutils
    - software-properties-common
    - sysstat
    - nmon

- name: Replace false to true in systat
  lineinfile:
    path: /etc/default/sysstat
    regexp: '^ENABLED='
    line: ENABLED=true

- name: Ensure systat is ENABLED=true
  lineinfile:
    path: /etc/default/sysstat
    regexp: '^ENABLED='
    line: ENABLED=true

- name: Remove useless packages from the cache
  apt:
   autoclean: yes

- name: Fix filled /boot
  shell: apt-get remove `dpkg --list 'linux-image*' | grep ^ii | awk '{print $2}'\ | grep -v \`uname -r\``

- name: Update APT package cache
  apt: update_cache=yes cache_valid_time=600

- name: Autoremove unused packages
  command: apt-get -y autoremove
  register: apt_result
  changed_when: "'packages will be REMOVED' in apt_result.stdout"

- name: Purge residual kernel packages
  shell: apt-get remove -y --purge $(dpkg -l | grep "^rc\s*linux-image-" | awk '{print $2}' | tr '\n' ' ')
  register: apt_result
  changed_when: "'packages will be REMOVED' in apt_result.stdout"
